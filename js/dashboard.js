// API í‚¤ ì„¤ì •
const API_KEYS = {
    kakao_js: '1ac6eee9b1e4c2e0cc6f1d1ca1a6a559',
    // Firebase ì„¤ì •ì€ ë‚˜ì¤‘ì— ì¶”ê°€
};

// Firebase ì„¤ì • (ì‹¤ì œ ì„¤ì •ê°’ìœ¼ë¡œ êµì²´ í•„ìš”)
const firebaseConfig = {
    // Firebase í”„ë¡œì íŠ¸ ì„¤ì •ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤
    apiKey: "your-api-key",
    authDomain: "your-project.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project.appspot.com",
    messagingSenderId: "123456789",
    appId: "your-app-id"
};

// Firebase ì´ˆê¸°í™” (ì‹¤ì œ ì‚¬ìš©ì‹œ ì£¼ì„ í•´ì œ)
// firebase.initializeApp(firebaseConfig);
// const db = firebase.firestore();


// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”„ í˜ì´ì§€ ë¡œë“œ - ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì‹œì‘');

    // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
    loadDashboardData();

    // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadDashboardData, 300000);
});


// ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
async function loadDashboardData() {
    try {
        console.log('ğŸ“Š ì‹¤ì œ ê¸°ì—… ë°ì´í„° ë¡œë“œ ì¤‘...');
        const response = await fetch('dashboard_data.json');
        if (response.ok) {
            const data = await response.json();
            const companies = data.companies || [];
            console.log('âœ… ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', companies.length + 'ê°œ ê¸°ì—… ë¶„ì„ ì™„ë£Œ');
            updateDashboardWithRealData(data, companies);
        } else {
            throw new Error('ê¸°ì—… ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ğŸš¨ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showError('ê¸°ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
}

// ì‹¤ì œ ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
function updateDashboardWithRealData(data, companies) {
    // ë©”íƒ€ë°ì´í„°ì—ì„œ í†µê³„ ì •ë³´ ì¶”ì¶œ
    const metadata = data.summary || {};
    
    // ì‹¤ì œ ë°ì´í„°ë¡œ ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
    updateStatusCardsReal(metadata, companies);
    
    // ì‹¤ì œ ë°ì´í„°ë¡œ íšŒì‚¬ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    updateCompanyListReal(companies);
    
    
    updateLastUpdateTime(metadata.collection_date);
}

// ì‹¤ì œ ë°ì´í„°ë¡œ ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateStatusCardsReal(metadata, companies) {
    const total = companies.length;
    const highRisk = companies.filter(c => c.risk_score >= 70).length;
    const collectionProgress = 100; // ìˆ˜ì§‘ ì™„ë£Œ
    
    document.getElementById('analyzedCompanies').textContent = total;
    document.getElementById('totalCompanies').textContent = total;
    document.getElementById('highRiskCompanies').textContent = highRisk;
    
    // ìˆ˜ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('collectionStatus').textContent = 'ì™„ë£Œ';
    document.getElementById('statusSpinner').style.display = 'none';
}

// ì‹¤ì œ ë°ì´í„°ë¡œ íšŒì‚¬ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
function updateCompanyListReal(companies) {
    const listContainer = document.getElementById('companyList');
    listContainer.innerHTML = '';

    // ìœ„í—˜ë„ ìˆœìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìœ„í—˜ë„ë¶€í„°)
    const sortedCompanies = companies.sort((a, b) => b.risk_score - a.risk_score);

    console.log('ğŸ“‹ ê¸°ì—… ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸:', sortedCompanies.length + 'ê°œ ê¸°ì—…');

    sortedCompanies.forEach(company => {
        const card = createCompanyCardReal(company);
        listContainer.appendChild(card);
    });
}

// ì‹¤ì œ ë°ì´í„°ë¡œ íšŒì‚¬ ì¹´ë“œ ìƒì„±
function createCompanyCardReal(company) {
    const col = document.createElement('div');
    col.className = 'col-md-6 mb-3';

    // ê¸°ë³¸ ë°ì´í„° ì„¤ì •
    const companyName = company.name || 'ë¯¸ìƒ';
    const district = company.district || 'ì§€ì—­ ì •ë³´ ì—†ìŒ';
    const employeeCount = company.employee_count ? company.employee_count.toLocaleString() : 'ì •ë³´ ì—†ìŒ';
    const industry = company.industry || 'ì—…ì¢… ì •ë³´ ì—†ìŒ';
    const riskLevel = company.risk_score >= 70 ? 'high' : company.risk_score >= 40 ? 'medium' : 'low';
    const riskColor = riskLevel === 'high' ? 'danger' : riskLevel === 'medium' ? 'warning' : 'success';
    const riskText = riskLevel === 'high' ? 'ê³ ìœ„í—˜' : riskLevel === 'medium' ? 'ì¤‘ìœ„í—˜' : 'ì €ìœ„í—˜';

    col.innerHTML = `
        <div class="card company-card border-${riskColor} border-2">
            <div class="card-body">
                <div class="row">
                    <div class="col-8">
                        <h6 class="card-title text-primary">${companyName}</h6>
                        <span class="badge bg-${riskColor}">${riskText} (${company.risk_score}%)</span>
                    </div>
                    <div class="col-4 text-end">
                        <small class="text-muted">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</small><br>
                        <small>${formatDate(company.last_update)}</small>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì§€ì—­:</strong>
                    </div>
                    <div class="col-9">
                        <small>${district}</small>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì„ì§ì›ìˆ˜:</strong>
                    </div>
                    <div class="col-9">
                        <strong class="text-info">${employeeCount}ëª…</strong>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì—…ì¢…:</strong>
                    </div>
                    <div class="col-9">
                        <span class="badge bg-secondary">${industry}</span>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì˜ˆì¸¡:</strong>
                    </div>
                    <div class="col-9">
                        <small class="text-muted">${company.prediction || 'ë¶„ì„ ì¤‘'}</small>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetailsReal('${companyName}')">
                        ìƒì„¸ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>
    `;

    return col;
}


// ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateStatusCards(companies) {
    const total = companies.length;
    const analyzed = companies.filter(c => c.analyzed).length;
    const highRisk = companies.filter(c => c.riskScore >= 80).length;
    const progress = total > 0 ? Math.round((analyzed / total) * 100) : 0;

    document.getElementById('analyzedCompanies').textContent = analyzed;
    document.getElementById('totalCompanies').textContent = total;
    document.getElementById('highRiskCompanies').textContent = highRisk;

    // ìˆ˜ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('collectionStatus').textContent = 'ì™„ë£Œ';
    document.getElementById('statusSpinner').style.display = 'none';
}

// íšŒì‚¬ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
function updateCompanyList(companies) {
    const listContainer = document.getElementById('companyList');
    listContainer.innerHTML = '';
    
    // ìœ„í—˜ë„ ìˆœìœ¼ë¡œ ì •ë ¬
    companies.sort((a, b) => b.riskScore - a.riskScore);
    
    companies.slice(0, 12).forEach(company => {
        const card = createCompanyCard(company);
        listContainer.appendChild(card);
    });
}

// íšŒì‚¬ ì¹´ë“œ ìƒì„±
function createCompanyCard(company) {
    const col = document.createElement('div');
    col.className = 'col-md-6 mb-3';

    const companyName = company.name || 'ë¯¸ìƒ';
    const district = company.district || company.address || 'ì§€ì—­ ì •ë³´ ì—†ìŒ';
    const employeeCount = company.employee_count || company.employees || 'ì„ì§ì›ìˆ˜ ì—†ìŒ';
    const industry = company.industry || 'ì—…ì¢… ì •ë³´ ì—†ìŒ';

    col.innerHTML = `
        <div class="card company-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-8">
                        <h6 class="card-title text-primary">${companyName}</h6>
                    </div>
                    <div class="col-4 text-end">
                        <small class="text-muted">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</small><br>
                        <small>${formatDate(company.lastUpdate)}</small>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì§€ì—­:</strong>
                    </div>
                    <div class="col-9">
                        ${district}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì„ì§ì›ìˆ˜:</strong>
                    </div>
                    <div class="col-9">
                        ${employeeCount}ëª…
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-3">
                        <strong>ì—…ì¢…:</strong>
                    </div>
                    <div class="col-9">
                        ${industry}
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${company.id}')">
                        ìƒì„¸ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>
    `;

    return col;
}

// ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ì—…ë°ì´íŠ¸
function updateLastUpdateTime(date) {
    const updateTime = date ? new Date(date) : new Date();
    document.getElementById('lastUpdate').textContent =
        `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${formatDate(updateTime)}`;
}

// ë‚ ì§œ í¬ë§·íŒ…
function formatDate(date) {
    if (!date) return '-';
    const d = new Date(date);
    return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
}

// ë°ì´í„° ìƒˆë¡œê³ ì¹¨
function refreshData() {
    document.getElementById('collectionStatus').textContent = 'ìˆ˜ì§‘ ì¤‘...';
    document.getElementById('statusSpinner').style.display = 'inline-block';
    
    setTimeout(() => {
        loadDashboardData();
        document.getElementById('collectionStatus').textContent = 'ì™„ë£Œ';
        document.getElementById('statusSpinner').style.display = 'none';
    }, 2000);
}

// ìƒì„¸ ì •ë³´ ë³´ê¸°
function viewDetails(companyId) {
    // ìƒì„¸ ëª¨ë‹¬ ë˜ëŠ” ìƒˆ í˜ì´ì§€ë¡œ ì´ë™
    alert(`${companyId} ìƒì„¸ ì •ë³´ (êµ¬í˜„ ì˜ˆì •)`);
}

// ì—ëŸ¬ í‘œì‹œ
function showError(message) {
    console.error('âŒ ' + message);

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('collectionStatus').textContent = 'ì˜¤ë¥˜';
    document.getElementById('statusSpinner').style.display = 'none';

    // ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    const listContainer = document.getElementById('companyList');
    listContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <h5>âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h5>
                <p>${message}</p>
                <button class="btn btn-outline-danger" onclick="loadDashboardData()">
                    ë‹¤ì‹œ ì‹œë„
                </button>
            </div>
        </div>
    `;
}

// ìƒì„¸ ì •ë³´ ë³´ê¸° (ì‹¤ì œ ë°ì´í„°ìš©)
function viewDetailsReal(companyName) {
    // TODO: ì‹¤ì œ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ êµ¬í˜„
    alert(`${companyName} ìƒì„¸ ì •ë³´\n\n- ì‚¬ë¬´ì‹¤ ì´ì „ ìœ„í—˜ë„ ë¶„ì„\n- ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ë° ê³µì‹œ ì •ë³´\n- ì„ëŒ€ì°¨ ê³„ì•½ ì •ë³´\n- ì‚¬ì—… í™•ì¥ ê³„íš\n\n(ìƒì„¸ ì •ë³´ í˜ì´ì§€ êµ¬í˜„ ì˜ˆì •)`);
}